pipeline {
    agent any
  
    parameters {
        string(name: 'SPEC', defaultValue: '/var/lib/jenkins/workspace/Jenkins_Test_Project/cypress/e2e/WebApplications/Test.cy.js', description: 'Enter the file')
        choice(name: 'BROWSER', choices: ['chrome', 'edge', 'firefox'], description: 'Choose the browser')
    }
  
    stages {
        stage('Building') {
            steps {
                echo 'Building the Application'
            }
        }
        
        stage('Prepare') {
            steps {
                sh 'npm install'
                sh 'npx cypress install'
            }
        }
      
        stage('Testing') {
            steps {
                script {
                    // Start Xvfb
                    sh 'Xvfb :99 -ac -screen 0 1280x1024x24 &'
                    env.DISPLAY = ':99'
                    
                    // Run Cypress with Xvfb
                    sh "npx cypress run --browser=${params.BROWSER} --spec ${params.SPEC}"
                }
            }
        }
      
        stage('Deploying') {
            steps {
                echo 'Deploying the Application'
            }
        }
    }
  
    post {
        always {
            publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'cypress/report', reportFiles: 'index.html', reportName: 'HTML Report', reportTitles: '', useWrapperFileDirectly: true])
        }
    }
}
